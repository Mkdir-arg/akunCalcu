{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard Comercial{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="relative overflow-hidden bg-gradient-to-br from-primary to-accent rounded-3xl mb-12 p-8 lg:p-12 text-white shadow-2xl animate-fade-in">
    <div class="absolute inset-0 bg-gradient-to-r from-black/10 to-transparent"></div>
    <div class="relative z-10">
        <h1 class="text-4xl lg:text-5xl font-bold mb-4 tracking-tight">Administración Comercial</h1>
        <p class="text-xl text-slate-200 font-medium">Gestión integral de ventas, gastos y reportes</p>
    </div>
</div>

<!-- Estadísticas -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-12 animate-scale-in">
    <div class="card-elegant bg-white rounded-3xl p-6 shadow-xl">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-slate-500 mb-2 font-medium">Total Ventas</p>
                <p class="text-3xl font-bold text-slate-700">${{ total_ventas|formato_numero }}</p>
            </div>
            <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-dollar-sign text-white text-xl"></i>
            </div>
        </div>
    </div>

    <div class="card-elegant bg-white rounded-3xl p-6 shadow-xl">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-slate-500 mb-2 font-medium">Total Gastos</p>
                <p class="text-3xl font-bold text-slate-700">${{ total_compras|formato_numero }}</p>
            </div>
            <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-shopping-cart text-white text-xl"></i>
            </div>
        </div>
    </div>

    <div class="card-elegant bg-white rounded-3xl p-6 shadow-xl">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-slate-500 mb-2 font-medium">Pendientes</p>
                <p class="text-3xl font-bold text-slate-700">{{ ventas_pendientes }}</p>
            </div>
            <div class="w-14 h-14 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-clock text-white text-xl"></i>
            </div>
        </div>
    </div>

    <div class="card-elegant bg-white rounded-3xl p-6 shadow-xl">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-slate-500 mb-2 font-medium">Clientes</p>
                <p class="text-3xl font-bold text-slate-700">{{ clientes_count }}</p>
            </div>
            <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-users text-white text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 animate-fade-in">
    <!-- Evolución Ventas/Compras -->
    <div class="card-elegant bg-white rounded-3xl shadow-xl p-6">
        <h3 class="text-xl font-bold text-slate-800 mb-4"><i class="fas fa-chart-line mr-2"></i>Evolución Últimos 6 Meses</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="evolucionChart"></canvas>
        </div>
    </div>
    
    <!-- Top 5 Clientes -->
    <div class="card-elegant bg-white rounded-3xl shadow-xl p-6">
        <h3 class="text-xl font-bold text-slate-800 mb-4"><i class="fas fa-trophy mr-2"></i>Top 5 Clientes</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="topClientesChart"></canvas>
        </div>
    </div>
</div>

<!-- Main Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
    <div class="group card-elegant bg-white rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-3xl flex items-center justify-center shadow-xl group-hover:shadow-2xl transition-all duration-300">
                <i class="fas fa-chart-line text-white text-2xl"></i>
            </div>
            <div class="ml-6">
                <h3 class="text-2xl font-bold text-slate-800 tracking-tight">Ventas</h3>
                <p class="text-sm text-slate-500 font-medium">Gestión completa</p>
            </div>
        </div>
        <div class="space-y-3">
            <a href="{% url 'comercial:ventas_list' %}" class="btn-primary inline-flex items-center justify-center w-full text-white px-6 py-3 rounded-2xl font-semibold shadow-lg">
                <i class="fas fa-list mr-2"></i>Ver Ventas
            </a>
            <a href="{% url 'comercial:venta_create' %}" class="inline-flex items-center justify-center w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-2xl font-semibold shadow-lg transition-all">
                <i class="fas fa-plus mr-2"></i>Nueva Venta
            </a>
            <a href="{% url 'comercial:clientes_list' %}" class="inline-flex items-center justify-center w-full bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-2xl font-semibold shadow-lg transition-all">
                <i class="fas fa-users mr-2"></i>Clientes
            </a>
        </div>
    </div>

    <div class="group card-elegant bg-white rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-3xl flex items-center justify-center shadow-xl group-hover:shadow-2xl transition-all duration-300">
                <i class="fas fa-shopping-cart text-white text-2xl"></i>
            </div>
            <div class="ml-6">
                <h3 class="text-2xl font-bold text-slate-800 tracking-tight">Gastos</h3>
                <p class="text-sm text-slate-500 font-medium">Control de egresos</p>
            </div>
        </div>
        <div class="space-y-3">
            <a href="{% url 'comercial:compras_list' %}" class="btn-primary inline-flex items-center justify-center w-full text-white px-6 py-3 rounded-2xl font-semibold shadow-lg">
                <i class="fas fa-list mr-2"></i>Ver Gastos
            </a>
            <a href="{% url 'comercial:compra_create' %}" class="inline-flex items-center justify-center w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-2xl font-semibold shadow-lg transition-all">
                <i class="fas fa-plus mr-2"></i>Nuevo Gasto
            </a>
            <a href="{% url 'comercial:cuentas_list' %}" class="inline-flex items-center justify-center w-full bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-2xl font-semibold shadow-lg transition-all">
                <i class="fas fa-folder mr-2"></i>Cuentas
            </a>
        </div>
    </div>

    <div class="group card-elegant bg-white rounded-3xl p-8 shadow-xl">
        <div class="flex items-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-3xl flex items-center justify-center shadow-xl group-hover:shadow-2xl transition-all duration-300">
                <i class="fas fa-chart-bar text-white text-2xl"></i>
            </div>
            <div class="ml-6">
                <h3 class="text-2xl font-bold text-slate-800 tracking-tight">Reportes</h3>
                <p class="text-sm text-slate-500 font-medium">Análisis contable</p>
            </div>
        </div>
        <div class="space-y-3">
            <a href="{% url 'comercial:reportes' %}" class="btn-primary inline-flex items-center justify-center w-full text-white px-6 py-3 rounded-2xl font-semibold shadow-lg">
                <i class="fas fa-file-alt mr-2"></i>Reporte Mensual
            </a>
            <a href="{% url 'comercial:reportes' %}" class="inline-flex items-center justify-center w-full bg-teal-500 hover:bg-teal-600 text-white px-6 py-3 rounded-2xl font-semibold shadow-lg transition-all">
                <i class="fas fa-search-dollar mr-2"></i>Por Cuenta
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico Evolución (Líneas)
    const ctx1 = document.getElementById('evolucionChart');
    if (ctx1) {
        const ventasMeses = {{ ventas_por_mes|safe }};
        const comprasMeses = {{ compras_por_mes|safe }};
        
        // Crear mapa de meses
        const mesesMap = new Map();
        ventasMeses.forEach(v => {
            const fecha = new Date(v.mes);
            const key = fecha.toLocaleDateString('es-AR', {month: 'short', year: 'numeric'});
            mesesMap.set(key, {ventas: v.total, compras: 0});
        });
        comprasMeses.forEach(c => {
            const fecha = new Date(c.mes);
            const key = fecha.toLocaleDateString('es-AR', {month: 'short', year: 'numeric'});
            if (mesesMap.has(key)) {
                mesesMap.get(key).compras = c.total;
            } else {
                mesesMap.set(key, {ventas: 0, compras: c.total});
            }
        });
        
        const labels = Array.from(mesesMap.keys());
        const ventasData = Array.from(mesesMap.values()).map(v => v.ventas);
        const comprasData = Array.from(mesesMap.values()).map(v => v.compras);
        
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ventas',
                        data: ventasData,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Gastos',
                        data: comprasData,
                        borderColor: 'rgba(239, 68, 68, 1)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: 'bold' },
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const parts = context.parsed.y.toFixed(2).split('.');
                                const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                                return context.dataset.label + ': $' + integerPart + ',' + parts[1];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico Top Clientes (Barras Horizontales)
    const ctx2 = document.getElementById('topClientesChart');
    if (ctx2) {
        const topClientes = {{ top_clientes|safe }};
        const labels = topClientes.map(c => c.cliente__nombre + ' ' + c.cliente__apellido);
        const data = topClientes.map(c => c.total);
        
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Ventas',
                    data: data,
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(168, 85, 247, 0.7)',
                        'rgba(236, 72, 153, 0.7)',
                        'rgba(251, 146, 60, 0.7)',
                        'rgba(34, 197, 94, 0.7)'
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(168, 85, 247, 1)',
                        'rgba(236, 72, 153, 1)',
                        'rgba(251, 146, 60, 1)',
                        'rgba(34, 197, 94, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const parts = context.parsed.x.toFixed(2).split('.');
                                const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                                return '$' + integerPart + ',' + parts[1];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}