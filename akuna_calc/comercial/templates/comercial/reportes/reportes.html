{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}
{% load l10n %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block title %}Reportes de Ingresos{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto animate-fade-in">
    <div class="mb-8">
        <h1 class="text-3xl lg:text-4xl font-bold text-slate-800 tracking-tight">Reportes de Ingresos</h1>
        <p class="text-slate-500 font-medium mt-1">Análisis y control de ingresos por pagos</p>
    </div>

    <!-- Formulario de Filtros -->
    <div class="card-elegant bg-white rounded-3xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-slate-800 mb-6 tracking-tight"><i class="fas fa-filter mr-2"></i>Filtros</h2>
        <form method="post">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Fecha Desde</label>
                    {{ form.fecha_desde }}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Fecha Hasta</label>
                    {{ form.fecha_hasta }}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Cliente</label>
                    {{ form.cliente }}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Estado</label>
                    {{ form.estado_venta }}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Factura</label>
                    {{ form.tipo_factura }}
                </div>
            </div>
            <div class="flex gap-4">
                <button type="submit" class="btn-primary inline-flex items-center text-white px-8 py-3 rounded-2xl font-semibold shadow-xl">
                    <i class="fas fa-search mr-2"></i>Generar Reporte
                </button>
                <a href="{% url 'comercial:reportes' %}" class="inline-flex items-center bg-slate-500 hover:bg-slate-600 text-white px-8 py-3 rounded-2xl font-semibold shadow-lg transition-all">
                    <i class="fas fa-redo mr-2"></i>Limpiar
                </a>
            </div>
        </form>
    </div>

    {% if reporte_data %}
    <!-- Gráfico de Ventas -->
    {% if reporte_data.ventas.total > 0 %}
    <div class="mb-8">
        <div class="card-elegant bg-white rounded-3xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4"><i class="fas fa-chart-bar mr-2"></i>Ventas por Tipo</h3>
            <div class="h-64">
                <canvas id="ventasChart" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Resumen de Ventas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Ingresos Blanco -->
        <div class="card-elegant bg-white rounded-3xl p-6 shadow-xl border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-500 mb-2 font-medium">Ingresos Blanco</p>
                    <p class="text-3xl font-bold text-green-600">${{ reporte_data.ventas.total_blanco|formato_numero }}</p>
                    <p class="text-xs text-slate-500 mt-1">{{ reporte_data.ventas.cantidad_blanco }} pagos</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-file-invoice text-white text-xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Ingresos Negro -->
        <div class="card-elegant bg-white rounded-3xl p-6 shadow-xl border-l-4 border-gray-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-500 mb-2 font-medium">Ingresos Negro</p>
                    <p class="text-3xl font-bold text-gray-600">${{ reporte_data.ventas.total_negro|formato_numero }}</p>
                    <p class="text-xs text-slate-500 mt-1">{{ reporte_data.ventas.cantidad_negro }} pagos</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-gray-500 to-gray-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-receipt text-white text-xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Total Ingresos -->
        <div class="card-elegant bg-white rounded-3xl p-6 shadow-xl border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-500 mb-2 font-medium">Total Ingresos</p>
                    <p class="text-3xl font-bold text-blue-600">${{ reporte_data.ventas.total|formato_numero }}</p>
                    <p class="text-xs text-slate-500 mt-1">{{ reporte_data.ventas.cantidad }} pagos</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabla de Ventas -->
    <div class="card-elegant bg-white rounded-3xl shadow-xl overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-8 py-6 border-b border-slate-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-slate-800 tracking-tight"><i class="fas fa-list mr-2"></i>Detalle de Ingresos</h3>
                <span class="text-3xl font-bold text-green-600">${{ reporte_data.ventas.total|formato_numero }}</span>
            </div>
        </div>
        {% if reporte_data.ventas.lista %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Pago</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pedido</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Forma Pago</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for ingreso in reporte_data.ventas.lista %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">{{ ingreso.fecha|date:"d/m/Y" }}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">
                            <a href="{% url 'comercial:venta_detail' ingreso.venta_id %}" class="text-blue-600 hover:text-blue-800 hover:underline">{{ ingreso.pedido }}</a>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ ingreso.cliente }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ ingreso.forma_pago }}</td>
                        <td class="px-6 py-4 text-sm text-green-600 font-semibold">${{ ingreso.monto|formato_numero }}</td>
                        <td class="px-6 py-4">
                            {% if ingreso.tipo == 'Blanco' %}
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Blanco</span>
                            {% else %}
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Negro</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-4 text-center text-gray-500">
            No hay ingresos registrados con los filtros seleccionados
        </div>
        {% endif %}
    </div>

    <!-- Botón de Exportación -->
    {% if reporte_data.ventas.cantidad > 0 %}
    <div class="mt-8 flex justify-center gap-4">
        <a href="{% url 'comercial:exportar_reporte_excel' %}" class="btn-primary inline-flex items-center text-white px-8 py-4 rounded-2xl font-semibold shadow-xl">
            <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
        </a>
        <button onclick="window.print()" class="inline-flex items-center bg-slate-600 hover:bg-slate-700 text-white px-8 py-4 rounded-2xl font-semibold shadow-xl transition-all">
            <i class="fas fa-print mr-2"></i>Imprimir
        </button>
    </div>
    {% endif %}
    {% else %}
    <div class="card-elegant bg-white rounded-3xl shadow-xl p-12 text-center">
        <i class="fas fa-chart-line text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-700 mb-2">No hay ingresos registrados</h3>
        <p class="text-gray-500 mb-6">Comienza registrando pagos en tus ventas para ver los reportes</p>
        <a href="{% url 'comercial:ventas_list' %}" class="btn-primary inline-flex items-center text-white px-8 py-3 rounded-2xl font-semibold shadow-xl">
            <i class="fas fa-list mr-2"></i>Ver Ventas
        </a>
    </div>
    {% endif %}
</div>

<style>
@media print {
    .no-print { display: none !important; }
    body { font-size: 12px; }
    .container { max-width: none; margin: 0; padding: 0; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Ventas
    const ctx = document.getElementById('ventasChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Blanco', 'Negro', 'Total'],
                datasets: [{
                    label: 'Ingresos',
                    data: [
                        parseFloat('{{ reporte_data.ventas.total_blanco|floatformat:2 }}'.replace('.', '').replace(',', '.')),
                        parseFloat('{{ reporte_data.ventas.total_negro|floatformat:2 }}'.replace('.', '').replace(',', '.')),
                        parseFloat('{{ reporte_data.ventas.total|floatformat:2 }}'.replace('.', '').replace(',', '.'))
                    ],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.7)',
                        'rgba(107, 114, 128, 0.7)',
                        'rgba(59, 130, 246, 0.7)'
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(107, 114, 128, 1)',
                        'rgba(59, 130, 246, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$' + context.parsed.y.toLocaleString('es-AR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-AR');
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
